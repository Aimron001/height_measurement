<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechatronics Dashboard - Ultra Responsive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .dimension-text { 
            font-family: 'JetBrains Mono', 'Fira Code', monospace; 
            font-weight: 800; 
            paint-order: stroke;
            stroke: white;
            stroke-width: 0.6px;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen p-4 md:p-8 overflow-x-hidden">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6" 
         x-data="{ 
            x: 0.42, y: 0.83, theta: 15,
            connected: false,
            vWidth: 800, 
            vHeight: 600,
            
            init() {
                const updateSize = () => {
                    const container = this.$refs.canvasContainer;
                    this.vWidth = container.clientWidth;
                    // Force more height on small screens to fit vertical dimensions
                    this.vHeight = window.innerWidth < 600 ? 550 : 600;
                };
                window.addEventListener('resize', updateSize);
                updateSize();
            },

            async connectBT() {
                try {
                    const port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    this.connected = true;
                    const decoder = new TextDecoderStream();
                    port.readable.pipeTo(decoder.writable);
                    const reader = decoder.readable.getReader();
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const lines = value.split('\n');
                        const lastLine = lines[lines.length - 2]; 
                        if (lastLine) {
                            const parts = lastLine.trim().split(',');
                            if(parts.length === 3) {
                                this.theta = parseFloat(parts[0]);
                                this.x = parseFloat(parts[1]);
                                this.y = parseFloat(parts[2]);
                            }
                        }
                    }
                } catch (err) { console.error(err); }
            },

            get h_offset() { return this.x * Math.tan(this.theta * Math.PI / 180) },
            get h_total() { return parseFloat(this.y) + this.h_offset + 0.06},
            get ladder_base() { return this.h_total / 4 },
            get ladder_len() { return Math.sqrt(Math.pow(this.ladder_base, 2) + Math.pow(this.h_total, 2)) },
            get ladder_angle() { return (Math.atan(this.h_total / this.ladder_base) * 180 / Math.PI).toFixed(1) },

            get scale() {
                // High padding (260) ensures the drawing is small enough to keep labels visible
                const padding = 260; 
                const totalWidth = Math.max(this.x, this.ladder_base) || 1;
                const totalHeight = Math.max(this.h_total, this.y) || 1;
                const scaleX = (this.vWidth - padding) / totalWidth;
                const scaleY = (this.vHeight - padding) / totalHeight;
                return Math.min(scaleX, scaleY);
            },

            // Adjust originX based on width to prevent right-side clipping
            get originX() { return this.vWidth < 522 ? this.vWidth - 60 : this.vWidth - 100 },
            get originY() { 
                const drawingHeight = Math.max(this.h_total, this.y) * this.scale;
                return (this.vHeight / 2) + (drawingHeight / 2) - 10;
            }
         }">
        
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-blue-400 font-black tracking-tighter text-xl">SYSTEM CTRL</h2>
                    <button @click="connectBT()" 
                            :class="connected ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/50' : 'bg-blue-600 text-white border-transparent'"
                            class="px-4 py-2 rounded-xl text-xs font-bold border transition-all">
                        <span x-text="connected ? 'LIVE' : 'CONNECT'"></span>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="bg-black/40 p-4 rounded-2xl border border-white/5">
                        <label class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Sensor X (Wall)</label>
                        <div class="text-2xl font-mono text-white" x-text="x.toFixed(3) + 'm'"></div>
                    </div>
                    <div class="bg-black/40 p-4 rounded-2xl border border-white/5">
                        <label class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Sensor Y (Floor)</label>
                        <div class="text-2xl font-mono text-white" x-text="y.toFixed(3) + 'm'"></div>
                    </div>
                    <div class="bg-black/40 p-4 rounded-2xl border border-blue-500/20">
                        <label class="text-[10px] text-blue-500 font-bold uppercase tracking-widest">Laser Angle (θ)</label>
                        <div class="text-2xl font-mono text-blue-400" x-text="theta.toFixed(1) + '°'"></div>
                    </div>
                </div>
            </div>

            <div class="bg-blue-600 p-6 rounded-3xl shadow-lg shadow-blue-900/20">
                <label class="text-[10px] text-blue-100 font-bold uppercase tracking-widest opacity-70">Req. Ladder Length</label>
                <div class="text-4xl font-black text-white" x-text="ladder_len.toFixed(2) + 'm'"></div>
                <div class="mt-4 pt-4 border-t border-white/10 flex justify-between text-blue-100 font-bold text-xs">
                    <span>Base A: <span x-text="ladder_base.toFixed(2) + 'm'"></span></span>
                    <span>H: <span x-text="h_total.toFixed(2) + 'm'"></span></span>
                </div>
            </div>
        </div>

        <div x-ref="canvasContainer" class="lg:col-span-3 bg-white rounded-[2rem] shadow-inner overflow-hidden relative border-8 border-slate-900 min-h-[550px]">
            <svg :viewBox="`0 0 ${vWidth} ${vHeight}`" class="w-full h-full transition-all duration-500" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <marker id="arr" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#1e293b" />
                    </marker>
                    <marker id="arr-emerald" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#10b981" />
                    </marker>
                    <marker id="arr-amber" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#f59e0b" />
                    </marker>
                </defs>

                <line x1="10" :y1="originY" :x2="vWidth-10" :y2="originY" stroke="#0f172a" stroke-width="3" />
                <line :x1="originX" :y1="originY - (Math.max(h_total, y) * scale) - 60" :x2="originX" :y2="originY" stroke="#0f172a" stroke-width="5" />

                <line :x1="originX - (ladder_base * scale)" :y1="originY" 
                      :x2="originX" :y2="originY - (h_total * scale)" 
                      stroke="#e2e8f0" stroke-width="22" stroke-linecap="round" />
                
                <line :x1="originX - (x * scale)" :y1="originY - (y * scale)" :x2="originX" :y2="originY - (y * scale)" 
                      stroke="#ef4444" stroke-width="2" stroke-dasharray="6,4" />
                <line :x1="originX - (x * scale)" :y1="originY - (y * scale)" :x2="originX" :y2="originY - (h_total * scale)" 
                      stroke="#ef4444" stroke-width="2" stroke-dasharray="6,4" />

                <circle :cx="originX" :cy="originY - (y * scale)" r="5" fill="#ef4444" stroke="white" stroke-width="1.5" />
                <circle :cx="originX" :cy="originY - (h_total * scale)" r="6" fill="#ef4444" stroke="white" stroke-width="2" />

                <rect :x="originX - (x * scale) - 20" :y="originY - (y * scale) - 15" width="40" height="30" rx="6" fill="#2563eb" />

                <line :x1="originX + 25" :y1="originY - (h_total * scale)" :x2="originX + 25" :y2="originY" stroke="#10b981" stroke-width="2" marker-start="url(#arr-emerald)" marker-end="url(#arr-emerald)" />
                <text :x="vWidth < 522 ? originX + 10 : originX + 45" 
                      :y="originY - (h_total * scale / 2)" 
                      text-anchor="middle" class="dimension-text" fill="#10b981" font-size="14" 
                      :transform="`rotate(90, ${vWidth < 522 ? originX + 10 : originX + 45}, ${originY - (h_total * scale / 2)})`" 
                      x-text="'H = ' + h_total.toFixed(2) + 'm'"></text>

                <line :x1="originX - (x * scale)" :y1="originY + 35" :x2="originX" :y2="originY + 35" stroke="#1e293b" stroke-width="2" marker-start="url(#arr)" marker-end="url(#arr)" />
                <text :x="originX - (x * scale / 2)" :y="originY + 55" text-anchor="middle" class="dimension-text" fill="#1e293b" font-size="14" x-text="'x=' + x.toFixed(2) + 'm'"></text>

                <line :x1="originX - (x * scale) - 30" :y1="originY - (y * scale)" :x2="originX - (x * scale) - 30" :y2="originY" stroke="#1e293b" stroke-width="2" marker-start="url(#arr)" marker-end="url(#arr)" />
                <text :x="originX - (x * scale) - 42" :y="originY - (y * scale / 2)" text-anchor="middle" class="dimension-text" fill="#1e293b" font-size="14" :transform="`rotate(-90, ${originX - (x * scale) - 42}, ${originY - (y * scale / 2)})`" x-text="'y=' + y.toFixed(2)"></text>

                <line :x1="originX - (ladder_base * scale)" :y1="originY + 12" :x2="originX" :y2="originY + 12" stroke="#f59e0b" stroke-width="2" marker-start="url(#arr-amber)" marker-end="url(#arr-amber)" />
                <text :x="originX - (ladder_base * scale / 2)" :y="originY + 28" text-anchor="middle" class="dimension-text" fill="#f59e0b" font-size="14" x-text="'A=' + ladder_base.toFixed(2)"></text>
            </svg>
        </div>
    </div>
</body>
</html>